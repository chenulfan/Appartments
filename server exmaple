const express = require('express')
const bodyParser = require('body-parser')
const verifyToken = require('./verify-token')
const jwt = require('jsonwebtoken')
const Api = require( "./Api")

require('dotenv').config()

const app = express()

app.use(bodyParser.json())
app.use(bodyParser.urlencoded({ extended: false }))


const Sequelize = require("sequelize")
const sequelize = new Sequelize('mysql://root:@localhost/appartments')

sequelize
  .authenticate()
  .then(() => {
    console.log('Connection has been established successfully.');
  })
  .catch(err => {
    console.error('Unable to connect to the database:', err);
  })


app.post('/api/posts', verifyToken, (req, res) => {
  // TODO: something
  res.json({
    message: 'Post created...'
  })
})

app.post('/api/login', async (req, res) => {

  const user = req.body
  console.log(user)
  let query = `SELECT username FROM user WHERE username="${user.user.username}" AND password="${user.user.password}"`
  let result = await sequelize.query(query)
  console.log(result[0][0])
  if (result[0][0] !== undefined) {
    jwt.sign({ user }, process.env.JWT_SECRET_KEY, { expiresIn: '1800s' }, (err, token) => {
      res.json({ token })
    })
  }
})

app.get('/api/user', verifyToken, (req, res) => {
  res.send(req.user.user)
})

app.listen(5000, () => console.log('Server started on port 5000'))